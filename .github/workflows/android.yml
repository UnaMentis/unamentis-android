name: Android CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      run_instrumented:
        description: 'Run instrumented tests'
        required: false
        default: false
        type: boolean

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: ktlint Check
      run: ./gradlew ktlintCheck --console=plain

    - name: detekt
      run: ./gradlew detekt --console=plain

    - name: Android Lint
      run: ./gradlew lint --console=plain

    - name: Upload Lint Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: lint-reports
        path: |
          app/build/reports/lint-results*.html
          app/build/reports/ktlint/
          app/build/reports/detekt/
        retention-days: 7

    - name: Summary
      if: always()
      run: |
        echo "## Lint Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ktlint | ${{ job.status == 'success' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| detekt | ${{ job.status == 'success' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Android Lint | ${{ job.status == 'success' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build
      run: ./gradlew assembleDebug --console=plain

    - name: Run Unit Tests
      run: ./gradlew test --console=plain

    - name: Upload Unit Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: |
          app/build/reports/tests/
          app/build/test-results/
        retention-days: 7

    - name: Summary
      if: always()
      run: |
        echo "## Unit Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -d "app/build/test-results/testDebugUnitTest" ]; then
          TESTS=$(find app/build/test-results/testDebugUnitTest -name "*.xml" -exec grep -h "tests=" {} \; | grep -oP 'tests="\K[0-9]+' | awk '{s+=$1} END {print s}')
          FAILURES=$(find app/build/test-results/testDebugUnitTest -name "*.xml" -exec grep -h "failures=" {} \; | grep -oP 'failures="\K[0-9]+' | awk '{s+=$1} END {print s}')
          ERRORS=$(find app/build/test-results/testDebugUnitTest -name "*.xml" -exec grep -h "errors=" {} \; | grep -oP 'errors="\K[0-9]+' | awk '{s+=$1} END {print s}')
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests Run | ${TESTS:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failures | ${FAILURES:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| Errors | ${ERRORS:-0} |" >> $GITHUB_STEP_SUMMARY
        else
          echo "No test results found" >> $GITHUB_STEP_SUMMARY
        fi

  instrumented-tests:
    name: Instrumented Tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || (github.event_name == 'pull_request' && github.base_ref == 'main') || github.event.inputs.run_instrumented == 'true'

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Enable KVM
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm

    - name: Run Instrumented Tests
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 34
        arch: x86_64
        profile: pixel_6
        target: google_apis
        emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -prop persist.sys.locales=en-US
        emulator-boot-timeout: 600
        disable-animations: true
        script: |
          # Wait for emulator to be fully booted
          adb wait-for-device
          adb shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'
          adb shell input keyevent 82

          # Ensure device locale is English (en-US) so tests that search for literal English strings succeed
          # Set modern property and also legacy language/country for compatibility
          adb shell "setprop persist.sys.locales en-US; setprop persist.sys.locale en-US; setprop persist.sys.language en; setprop persist.sys.country US" || true

          # Restart runtime so locale changes apply, then wait for boot again
          adb shell stop || true
          adb shell start || true
          adb shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'
          adb shell input keyevent 82

          # Run instrumented tests
          ./gradlew connectedAndroidTest --console=plain

    - name: Upload Instrumented Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: instrumented-test-results
        path: |
          app/build/reports/androidTests/
          app/build/outputs/androidTest-results/
        retention-days: 7

    - name: Summary
      if: always()
      run: |
        echo "## Instrumented Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -d "app/build/outputs/androidTest-results" ]; then
          echo "Instrumented tests completed. See artifacts for details." >> $GITHUB_STEP_SUMMARY
        else
          echo "No instrumented test results found" >> $GITHUB_STEP_SUMMARY
        fi

  build-release:
    name: Build Release APK
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build Release APK
      run: ./gradlew assembleRelease --console=plain

    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: release-apk
        path: app/build/outputs/apk/release/*.apk
        retention-days: 30

  commit-results:
    name: Commit CI Results
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, instrumented-tests]
    if: always() && github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip-ci-log]')

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 1
      continue-on-error: true

    - name: Fallback Checkout
      if: failure()
      run: |
        git clone --depth 1 https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git .
        git checkout ${{ github.ref_name }} || git checkout -b ${{ github.ref_name }}
      continue-on-error: true

    - name: Generate CI Results Log
      id: generate-log
      continue-on-error: true
      env:
        RUN_ID: ${{ github.run_id }}
        RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        BRANCH: ${{ github.ref_name }}
        COMMIT_SHA: ${{ github.sha }}
        ACTOR: ${{ github.actor }}
        REPO: ${{ github.repository }}
        LINT_RESULT: ${{ needs.lint.result || 'skipped' }}
        UNIT_RESULT: ${{ needs.unit-tests.result || 'skipped' }}
        INSTRUMENTED_RESULT: ${{ needs.instrumented-tests.result || 'skipped' }}
      run: |
        mkdir -p ci-logs

        {
          echo "# CI Results"
          echo ""
          echo "| Field | Value |"
          echo "|-------|-------|"
          echo "| Run | [${RUN_ID}](${RUN_URL}) |"
          echo "| Branch | ${BRANCH} |"
          echo "| Commit | \`${COMMIT_SHA:0:7}\` |"
          echo "| Triggered by | ${ACTOR} |"
          echo "| Date | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |"
          echo ""
          echo "## Job Results"
          echo ""
          echo "| Job | Status |"
          echo "|-----|--------|"
          echo "| Lint | ${LINT_RESULT} |"
          echo "| Unit Tests | ${UNIT_RESULT} |"
          echo "| Instrumented Tests | ${INSTRUMENTED_RESULT} |"
          echo ""

          if [ "${LINT_RESULT}" = "failure" ] || [ "${UNIT_RESULT}" = "failure" ] || [ "${INSTRUMENTED_RESULT}" = "failure" ]; then
            echo "## Action Required"
            echo ""
            echo "One or more jobs failed. [View full logs](${RUN_URL}) to investigate."
            echo ""
          fi

          echo "---"
          echo "*Auto-generated by CI at $(date -u +'%Y-%m-%d %H:%M:%S UTC')*"
        } > ci-logs/latest-results.md

        echo "Generated ci-logs/latest-results.md"
        cat ci-logs/latest-results.md

    - name: Fallback Minimal Log
      if: steps.generate-log.outcome == 'failure'
      run: |
        mkdir -p ci-logs
        echo "# CI Results (Minimal)" > ci-logs/latest-results.md
        echo "" >> ci-logs/latest-results.md
        echo "Log generation encountered an error." >> ci-logs/latest-results.md
        echo "" >> ci-logs/latest-results.md
        echo "[View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> ci-logs/latest-results.md

    - name: Commit and Push Results
      continue-on-error: true
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git pull --rebase origin ${{ github.ref_name }} || true

        git add ci-logs/latest-results.md

        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore: Update CI results [skip-ci-log]"

          for i in 1 2 3; do
            if git push origin ${{ github.ref_name }}; then
              echo "Push successful"
              break
            else
              echo "Push attempt $i failed, retrying..."
              sleep 2
              git pull --rebase origin ${{ github.ref_name }} || true
            fi
          done
        fi
